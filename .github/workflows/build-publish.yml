name: Build and Publish
permissions:
    id-token: write

on:
    workflow_dispatch:
        inputs:
            force_build:
                description: "Force build even if PyPI is up to date"
                required: false
                type: boolean
                default: false
            tag:
                description: "Specific upstream tag to build (e.g. v0.5.0)"
                required: false
                type: string

    schedule:
        - cron: "0 */6 * * *"

    push:
        branches: [main]
        paths:
            - "main.py"
            - "Dockerfile"
            - "pyproject.toml"
            - "uv.lock"
            - ".github/workflows/**"

jobs:
    check:
        name: Check upstream version
        runs-on: ubuntu-latest
        outputs:
            should_build: ${{ steps.check.outputs.should_build }}
            tag: ${{ steps.check.outputs.tag }}
            version: ${{ steps.check.outputs.version }}

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - id: check
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ARGS="--check-only"
                  if [ -n "${{ github.event.inputs.tag }}" ]; then
                    ARGS="$ARGS --tag ${{ github.event.inputs.tag }}"
                  fi
                  if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
                    ARGS="$ARGS --force"
                  fi
                  python main.py $ARGS

    build_linux:
        name: Build wheel (Linux x86_64, manylinux)
        needs: check
        if: needs.check.outputs.should_build == 'true'
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: astral-sh/setup-uv@v5

            - name: Install Python deps
              run: uv sync

            - name: Prepare upstream source
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG: ${{ needs.check.outputs.tag }}
              run: |
                  ARGS=(--prepare-only --tag "$TAG" --prepare-dir "$GITHUB_WORKSPACE/.regorus-src")
                  if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
                      ARGS+=(--force)
                  fi
                  uv run python main.py "${ARGS[@]}"

            - name: Build manylinux wheel
              uses: PyO3/maturin-action@v1
              with:
                  command: build
                  args: --release --out ${{ github.workspace }}/dist
                  working-directory: ${{ github.workspace }}/.regorus-src/regorus/bindings/python
                  manylinux: auto
              env:
                  NODE_OPTIONS: "--max-old-space-size=4096"

            - name: Inject typing stubs
              env:
                  TAG: ${{ needs.check.outputs.tag }}
              run: |
                  uv run python - <<'EOF'
                  import os
                  from pathlib import Path
                  from celine_regorus_builder.build import stub_dir
                  from celine_regorus_builder.wheel import inject_typing

                  tag = os.environ["TAG"]
                  dist = Path("dist")
                  stub_pyi = stub_dir / f"{tag}.pyi"

                  if not stub_pyi.exists():
                      from celine_regorus_builder.stubgen_rust import generate_regorus_pyi_from_lib_rs
                      lib_rs = Path(os.environ["GITHUB_WORKSPACE"]) / ".regorus-src/regorus/bindings/python/src/lib.rs"
                      pyi_bytes = generate_regorus_pyi_from_lib_rs(lib_rs)
                  else:
                      pyi_bytes = stub_pyi.read_bytes()

                  for w in dist.glob("*.whl"):
                      inject_typing(w, pyi_bytes)
                      print(f"[INFO] Injected stubs into {w.name}")
                  EOF

            - name: Smoke test
              run: |
                  pip install dist/*manylinux*.whl
                  python -c "import regorus; print('OK:', regorus)"

            - uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux
                  path: dist/*.whl



    build_macos:
        name: Build wheel (macOS ${{ matrix.target }})
        needs: check
        if: needs.check.outputs.should_build == 'true'
        runs-on: ${{ matrix.runner }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: aarch64-apple-darwin
                      runner: macos-latest        # macos-latest is ARM (M1)
                    - target: x86_64-apple-darwin
                      runner: macos-15-intel 

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - uses: astral-sh/setup-uv@v5

            - name: Install Python deps
              run: uv sync

            - name: Build wheel
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG: ${{ needs.check.outputs.tag }}
              run: |
                  mkdir -p dist
                  ARGS=(--tag "$TAG" --output-dir dist --rust-target ${{ matrix.target }})
                  if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
                      ARGS+=(--force)
                  fi
                  uv run python main.py "${ARGS[@]}"

            - name: Smoke test
              run: |
                  python -m pip install dist/*.whl
                  python - <<'EOF'
                  import regorus
                  print("OK:", regorus)
                  EOF

            - uses: actions/upload-artifact@v4
              with:
                  name: wheels-macos-${{ matrix.target }}
                  path: dist/*.whl

    publish:
        name: Publish to PyPI
        needs: [check, build_linux, build_macos]
        if: needs.check.outputs.should_build == 'true'
        runs-on: ubuntu-latest
        environment: pypi
        permissions:
            id-token: write

        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Publish
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/